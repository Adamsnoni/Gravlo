rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Users & Profiles ──────────────────────────────────────────────────────
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;

      // ── Properties ───────────────────────────────────────────────────────────
      match /properties/{propId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;

        // ── Units ────────────────────────────────────────────────────────────────
        match /units/{unitId} {
          // Owner (landlord) has full access
          allow read, write: if request.auth != null && request.auth.uid == uid;

          // Any authenticated user can read units for the tenant join/portal flow.
          // This is safe: unit data (name, rent, status) is non-sensitive public info
          // shared intentionally via the invite link.
          allow read: if request.auth != null;
        }

        // ── Payments ─────────────────────────────────────────────────────────────
        match /payments/{payId} {
          allow read, write: if request.auth != null && request.auth.uid == uid;
        }

        // ── Maintenance ───────────────────────────────────────────────────────────
        match /maintenance/{ticketId} {
          allow read, write: if request.auth != null && request.auth.uid == uid;
        }
      }

      // ── Reminders ────────────────────────────────────────────────────────────
      match /reminders/{remId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }

      // ── Notifications ─────────────────────────────────────────────────────────
      match /notifications/{notifId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
    }

    // ── Top-level invoices collection ─────────────────────────────────────────
    match /invoices/{invoiceId} {
      allow read: if request.auth != null &&
        (resource.data.landlordId == request.auth.uid ||
         resource.data.tenantId  == request.auth.uid);
      allow create: if request.auth != null;
      allow update: if request.auth != null &&
        (resource.data.landlordId == request.auth.uid ||
         resource.data.tenantId  == request.auth.uid);
    }

    // ── Tenancies top-level collection ───────────────────────────────────────
    match /tenancies/{tenancyId} {
      allow read: if request.auth != null &&
        (resource.data.landlordId == request.auth.uid ||
         resource.data.tenantId   == request.auth.uid);
      allow create, update: if request.auth != null;
    }

    // ── Invite tokens ─────────────────────────────────────────────────────────
    match /inviteTokens/{tokenId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
  }
}
