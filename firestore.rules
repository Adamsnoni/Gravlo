rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Users & Profiles ──────────────────────────────────────────────────────
    // ── Collection Group Rules ──────────────────────────────────────────────
    // Required for collectionGroup queries used in the dashboard & notifications
    match /{path=**}/units/{unitId} {
      allow read: if request.auth != null && (
        resource.data.landlordId == request.auth.uid || 
        resource.data.tenantId == request.auth.uid ||
        resource.data.status == 'vacant'
      );
    }

    match /{path=**}/payments/{payId} {
      allow read: if request.auth != null && (
        resource.data.landlordId == request.auth.uid || 
        resource.data.tenantId == request.auth.uid
      );
    }

    match /{path=**}/maintenance/{ticketId} {
      allow read: if request.auth != null && (
        resource.data.landlordId == request.auth.uid || 
        resource.data.tenantId == request.auth.uid
      );
    }

    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;

      // ── Properties ───────────────────────────────────────────────────────────
      match /properties/{propId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
        allow delete: if request.auth != null && request.auth.uid == uid;

        // ── Units (Legacy path-based rules) ─────────────────────────────────────
        match /units/{unitId} {
          allow read, write: if request.auth != null && request.auth.uid == uid;
          allow delete: if request.auth != null && request.auth.uid == uid;
          
          // Tenants can request to join a vacant unit
          allow update: if request.auth != null 
            && resource.data.status == 'vacant'
            && request.resource.data.status == 'pending_approval'
            && request.resource.data.pendingTenantId == request.auth.uid;
        }

        // ── Payments ─────────────────────────────────────────────────────────────
        match /payments/{payId} {
          allow read, write: if request.auth != null && request.auth.uid == uid;
        }

        // ── Maintenance ───────────────────────────────────────────────────────────
        match /maintenance/{ticketId} {
          allow read: if request.auth != null && (request.auth.uid == uid || resource.data.tenantId == request.auth.uid);
          allow write: if request.auth != null && request.auth.uid == uid;
          // Tenants can create maintenance tickets
          allow create: if request.auth != null && request.resource.data.tenantId == request.auth.uid;
        }
      }

      // ── Reminders ────────────────────────────────────────────────────────────
      match /reminders/{remId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }

      match /notifications/{notifId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
        // Allow authenticated users to send join requests/notifications to the landlord
        allow create: if request.auth != null;
      }
    }

    // ── Top-level invoices collection ─────────────────────────────────────────
    match /invoices/{invoiceId} {
      allow read: if request.auth != null &&
        (resource.data.landlordId == request.auth.uid ||
         resource.data.tenantId  == request.auth.uid);
      // NO client creates. Handled entirely via Cloud Functions after payment.
      allow create, update, delete: if false;
    }

    // ── Tenancies top-level collection ───────────────────────────────────────
    match /tenancies/{tenancyId} {
      allow read: if request.auth != null &&
        (resource.data.landlordId == request.auth.uid ||
         resource.data.tenantId   == request.auth.uid);
      // Landlords can manage leases for units they own
      allow create: if request.auth != null && request.resource.data.landlordId == request.auth.uid;
      allow update: if request.auth != null && resource.data.landlordId == request.auth.uid;
      allow delete: if false;
    }

    // ── Invite tokens ─────────────────────────────────────────────────────────
    match /inviteTokens/{tokenId} {
      // Allow public get for unauthenticated prospects to verify links
      allow get: if true;
      allow list: if false;
      // Allow ONLY the landlord to create/revoke tokens. Acceptance is handled by CF.
      allow create, delete: if request.auth != null && request.resource.data.landlordUid == request.auth.uid;
      allow update: if request.auth != null && resource.data.landlordUid == request.auth.uid;
    }
  }
}
